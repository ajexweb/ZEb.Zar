<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom styles to match the Image's Light/Green theme */
        
        /* Background: Very light mint/off-white (matching the image) */
        .bg-custom-light {
            background-color: #f0fdfa; /* Lightest mint/teal shade */
        }
        
        /* Card Background: White with soft, prominent rounded corners (matching the image) */
        .bg-custom-card {
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Soft shadow */
            border-radius: 1.5rem; /* More rounded corners for the main card */
        }

        /* Custom gradient for the Champion card (Themed Green/Teal) */
        .green-gradient { 
            background: linear-gradient(135deg, #10b981 0%, #047857 100%); /* Emerald/Dark Green Gradient */
            color: #ffffff; /* White text on green */
            position: relative;
        }
        .green-gradient::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 1.5rem; /* Matches main card rounded-xl */
            border: 4px solid #34d399; /* Bright green border for champion */
            pointer-events: none;
        }
        
        /* Custom text colors for the green theme */
        .text-primary-green {
            color: #0d9488; /* Darker Teal/Cyan for main text/accents */
        }
    </style>
</head>
<body class="bg-custom-light text-gray-800 min-h-screen font-sans">

    <header class="bg-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-2xl mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <button 
                    class="text-teal-600 mr-4 p-2 rounded-full hover:bg-gray-100 transition"
                    onclick="window.location.href='index.html'"
                >
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h1 class="text-xl font-bold text-gray-800">FF Tournament</h1>
            </div>
            <span class="text-xs bg-teal-600 text-white px-3 py-1 rounded-full font-semibold">Live Results</span>
        </div>
    </header>

    <div id="loading" class="text-center mt-10 text-gray-500">
        <i class="fas fa-spinner fa-spin fa-2x"></i><br>Loading results...
    </div>

    <main id="feed" class="max-w-2xl mx-auto p-4 space-y-6 pb-10"></main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // RTDB Imports
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Configuration (Your provided config)
        const firebaseConfig = {
            apiKey: "AIzaSyAkcBlyH2QPPZtGN5t9eqYmuQ_E9dGo4b0",
            authDomain: "fir-bf6f1.firebaseapp.com",
            databaseURL: "https://fir-bf6f1-default-rtdb.firebaseio.com",
            projectId: "fir-bf6f1",
            storageBucket: "fir-bf6f1.firebasestorage.app",
            messagingSenderId: "432545170995",
            appId: "1:432545170995:web:b6deccf31b79eb6ef1c546"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); // Get Realtime Database instance
        const auth = getAuth(app);

        // Attempt anonymous sign-in
        signInAnonymously(auth).then(() => {
            console.log("User connected anonymously.");
            loadMatches();
        }).catch(e => {
            document.getElementById('loading').innerText = "Authentication Error: " + e.message;
            console.error("Auth Error:", e);
        });

        /**
         * Formats the date string into a localized, readable format.
         * @param {string} dateString 
         * @returns {string}
         */
        function formatDate(dateString) {
            if (!dateString) return '';
            // Using 'en-US' locale for English output
            return new Date(dateString).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
        }

        /**
         * Fetches and displays match results from Firebase Realtime Database.
         */
        function loadMatches() {
            const feed = document.getElementById('feed');
            const loading = document.getElementById('loading');

            // Reference to the 'matches' node in the Realtime DB
            const matchesRef = ref(db, 'matches/');

            onValue(matchesRef, (snapshot) => {
                loading.style.display = 'none';
                feed.innerHTML = ''; // Clear previous content
                
                const matchesData = snapshot.val(); // Get all matches as a JavaScript object
                let matches = [];

                if (matchesData) {
                    // Necessary to convert RTDB object to an array for easy iteration/sorting
                    for (const id in matchesData) {
                        matches.push({ id, ...matchesData[id] });
                    }
                }

                // Sort matches by date (Newest match first)
                matches.sort((a, b) => new Date(b.matchDate) - new Date(a.matchDate));

                if (matches.length === 0) {
                    feed.innerHTML = '<div class="text-center text-gray-500 p-8 bg-white rounded-2xl mt-4 shadow-lg">No results found yet.</div>';
                    return;
                }

                matches.forEach(match => {
                    // Sort winners by rank
                    const sortedWinners = match.winners ? match.winners.sort((a, b) => a.rank - b.rank) : [];
                    
                    const champion = sortedWinners.find(w => w.rank === 1) || sortedWinners[0];
                    const otherWinners = sortedWinners.filter(w => w !== champion);

                    let html = `
                    <article class="bg-custom-card rounded-2xl overflow-hidden shadow-xl border border-gray-100">
                        
                        <div class="bg-teal-500/10 px-4 py-3 text-xs text-primary-green font-semibold flex justify-between">
                            <span><i class="far fa-calendar-alt mr-1"></i> Match Date: ${formatDate(match.matchDate)}</span>
                        </div>
                        
                        ${champion ? `
                        <div class="green-gradient p-6 text-center relative rounded-3xl m-4">
                            <div class="text-xs font-bold mb-1 text-white opacity-80">MATCH CHAMPION</div>
                            <div class="inline-block bg-white rounded-full p-3 shadow-xl mb-2">
                                <i class="fas fa-crown text-3xl text-green-600"></i>
                            </div>
                            <h2 class="text-2xl font-extrabold uppercase truncate">${champion.name || 'N/A'}</h2>
                            <div class="text-sm font-medium opacity-90 mb-3 text-white">UID: ${champion.uid || 'N/A'}</div>
                            <div class="flex justify-center gap-4 text-sm font-bold mt-2">
                                <div class="bg-white/20 px-4 py-1 rounded-full text-white">‚ò†Ô∏è ${champion.kills || 0} Kills</div>
                                <div class="bg-white/30 px-4 py-1 rounded-full text-white">üèÜ ‚Çπ${champion.prize || 0}</div>
                            </div>
                        </div>` : ''}
                        
                        <div class="p-4 pt-0 space-y-3">
                            ${otherWinners.map(p => `
                                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-200 hover:bg-gray-100 transition">
                                    <div class="flex items-center gap-3">
                                        <span class="bg-teal-600 w-8 h-8 flex items-center justify-center rounded-lg text-sm font-bold text-white shadow-md">#${p.rank || 'N/A'}</span>
                                        <div>
                                            <div class="font-bold text-sm text-gray-700">${p.name || 'N/A'}</div>
                                            <div class="text-[10px] text-gray-500">UID: ${p.uid || 'N/A'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-green-600 font-bold text-sm">‚Çπ${p.prize || 0}</div>
                                        <div class="text-[10px] text-gray-500">${p.kills || 0} Kills</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${match.losers && match.losers.length > 0 ? `
                        <div class="bg-gray-50 p-4 border-t border-gray-200">
                            <h3 class="text-xs font-bold text-red-500 mb-2 uppercase border-b border-red-200 pb-1">Eliminated Players</h3>
                            <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                                ${match.losers.map(l => `
                                    <div class="flex flex-col bg-white p-2 rounded-lg text-xs border border-gray-200 shadow-sm text-center">
                                        <span class="text-gray-700 font-medium truncate">${l.name || 'N/A'}</span>
                                        <span class="text-red-400 font-semibold">‚ò†Ô∏è ${l.kills || 0}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </article>`;
                    feed.innerHTML += html;
                });
            }, error => {
                console.error(error);
                loading.innerText = "Error: Could not load data.";
                loading.style.display = 'block';
            });
        }
    </script>
</body>
</html>
